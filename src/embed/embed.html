<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nice</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 36px;
      padding: 4px;
    }

    .nice-button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border: none;
      border-radius: 18px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .nice-button:hover {
      transform: scale(1.02);
    }

    .nice-button:active {
      transform: scale(0.98);
    }

    /* Light theme (default) */
    .theme-light .nice-button {
      background: #f3f4f6;
      color: #374151;
    }

    .theme-light .nice-button:hover {
      background: #e5e7eb;
    }

    .theme-light .nice-button.niced {
      background: #fef3c7;
      color: #92400e;
    }

    /* Dark theme */
    .theme-dark .nice-button {
      background: #374151;
      color: #f3f4f6;
    }

    .theme-dark .nice-button:hover {
      background: #4b5563;
    }

    .theme-dark .nice-button.niced {
      background: #78350f;
      color: #fef3c7;
    }

    /* Minimal theme */
    .theme-minimal .nice-button {
      background: transparent;
      color: inherit;
      border: 1px solid currentColor;
      opacity: 0.7;
    }

    .theme-minimal .nice-button:hover {
      opacity: 1;
    }

    .theme-minimal .nice-button.niced {
      opacity: 1;
      border-color: #f59e0b;
      color: #f59e0b;
    }

    /* Icon */
    .nice-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .nice-icon svg {
      width: 100%;
      height: 100%;
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .niced .nice-icon svg {
      fill: currentColor;
    }

    /* Count */
    .nice-count {
      font-variant-numeric: tabular-nums;
    }

    /* Animations */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-3px); }
      75% { transform: translateX(3px); }
    }

    .nice-button.animating {
      animation: pulse 0.3s ease;
    }

    .nice-button.shake {
      animation: shake 0.3s ease;
    }

    /* Disabled state */
    .nice-button.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .nice-button.disabled:hover {
      transform: none;
    }
  </style>
</head>
<body class="theme-light">
  <button class="nice-button" id="niceBtn">
    <span class="nice-icon">
      <!-- Thumbs up icon -->
      <svg viewBox="0 0 24 24">
        <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
      </svg>
    </span>
    <span class="nice-count" id="niceCount">0</span>
  </button>

  <script>
    (function() {
      'use strict';

      const API_BASE = '{{API_BASE}}';
      const BUTTON_ID = '{{BUTTON_ID}}';
      const THEME = '{{THEME}}';

      const btn = document.getElementById('niceBtn');
      const countEl = document.getElementById('niceCount');
      
      let count = 0;
      let hasNiced = false;
      let isLoading = false;

      // Set theme
      document.body.className = 'theme-' + THEME;

      // Format count for display
      function formatCount(n) {
        if (n >= 1000000000) return (n / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
        if (n >= 1000000) return (n / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
        if (n >= 1000) return (n / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
        return n.toString();
      }

      // Update display
      function updateDisplay() {
        countEl.textContent = formatCount(count);
        if (hasNiced) {
          btn.classList.add('niced');
        }
        notifyResize();
      }

      // Notify parent of size change
      function notifyResize() {
        const rect = btn.getBoundingClientRect();
        parent.postMessage({
          type: 'nice-resize',
          buttonId: BUTTON_ID,
          width: Math.ceil(rect.width) + 8,
          height: Math.ceil(rect.height) + 8
        }, '*');
      }

      // Generate lightweight fingerprint
      function getFingerprint() {
        const data = [
          screen.width + 'x' + screen.height,
          new Date().getTimezoneOffset(),
          navigator.language,
          navigator.userAgent.slice(0, 50)
        ].join('|');
        
        // Simple hash
        let hash = 0;
        for (let i = 0; i < data.length; i++) {
          hash = ((hash << 5) - hash) + data.charCodeAt(i);
          hash = hash & hash;
        }
        return hash.toString(36);
      }

      // Fetch initial count
      async function fetchCount() {
        try {
          const res = await fetch(`${API_BASE}/api/v1/nice/${BUTTON_ID}/count`);
          if (res.ok) {
            const data = await res.json();
            count = data.count || 0;
            updateDisplay();
          }
        } catch (e) {
          console.error('Nice: Failed to fetch count', e);
        }
      }

      // Record nice
      async function recordNice() {
        if (isLoading) return;
        
        // If already niced, show shake animation
        if (hasNiced) {
          btn.classList.add('shake');
          setTimeout(() => btn.classList.remove('shake'), 300);
          return;
        }

        isLoading = true;

        // Optimistic update
        count++;
        hasNiced = true;
        btn.classList.add('animating');
        updateDisplay();

        setTimeout(() => btn.classList.remove('animating'), 300);

        try {
          const res = await fetch(`${API_BASE}/api/v1/nice/${BUTTON_ID}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fingerprint: getFingerprint() })
          });

          const data = await res.json();

          if (res.ok) {
            count = data.count;
            if (!data.success && data.reason === 'already_niced') {
              hasNiced = true;
            }
          } else if (res.status === 429) {
            // Rate limited - revert optimistic update
            count--;
            hasNiced = false;
            btn.classList.remove('niced');
          }

          updateDisplay();
        } catch (e) {
          // Revert on error
          count--;
          hasNiced = false;
          btn.classList.remove('niced');
          updateDisplay();
          console.error('Nice: Failed to record', e);
        } finally {
          isLoading = false;
        }
      }

      // Check if button exists and site is verified
      async function checkButton() {
        try {
          const res = await fetch(`${API_BASE}/api/v1/nice/${BUTTON_ID}/count`);
          if (!res.ok) {
            btn.classList.add('disabled');
            btn.title = 'Button not available';
          }
        } catch (e) {
          btn.classList.add('disabled');
        }
      }

      // Event listeners
      btn.addEventListener('click', recordNice);

      // Initialize
      if (BUTTON_ID && BUTTON_ID !== '{{BUTTON_ID}}') {
        checkButton();
        fetchCount();
      } else {
        btn.classList.add('disabled');
      }

      // Initial resize notification
      setTimeout(notifyResize, 100);
    })();
  </script>
</body>
</html>
